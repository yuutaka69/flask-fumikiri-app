<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¸åˆ‡æ¤œç´¢ãƒãƒƒãƒ— (Flaskç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
        }
        .sidebar {
            width: 300px;
            padding: 20px;
            background-color: #f8f9fa;
            height: 100vh;
            overflow-y: auto;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .map-container {
            flex-grow: 1;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>æ¤œç´¢æ¡ä»¶</h3>
        <form method="post">
            <div class="mb-3">
                <label for="search_name" class="form-label">è¸åˆ‡åã§æ¤œç´¢</label>
                <input type="text" class="form-control" id="search_name" name="search_name" value="{{ request.form.search_name }}">
            </div>

            {% for col, options in filters.items() %}
            <div class="mb-3">
                <label for="{{ col }}" class="form-label">{{ col }}ã§çµã‚Šè¾¼ã¿</label>
                <select class="form-select" id="{{ col }}" name="{{ col }}">
                    <option value="ã™ã¹ã¦">ã™ã¹ã¦</option>
                    {% for option in options %}
                    <option value="{{ option }}" {% if request.form[col] == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}
            
            <button type="submit" class="btn btn-primary w-100">æ¤œç´¢</button>
        </form>
    </div>

    <div class="main-content">
        <h1>è¸åˆ‡æ¤œç´¢ãƒãƒƒãƒ— ğŸ—ºï¸</h1>
        <p>è¡¨ç¤ºä»¶æ•°: {{ count }}ä»¶</p>
        <div class="map-container">
            {% if map_html %}
                {{ map_html|safe }}
            {% else %}
                <p class="text-center p-5">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¸åˆ‡ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            {% endif %}
        </div>
    </div>
</body>
</html>
```

#### **3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä½œæˆ (`app.py`)**

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«`app.py`ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚ã“ã‚ŒãŒãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã€çµã‚Šè¾¼ã¿ã€åœ°å›³ã®ç”Ÿæˆã¨ã„ã£ãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã‚’æ‹…å½“ã—ã¾ã™ã€‚


```python
# app.py
from flask import Flask, render_template, request
import pandas as pd
import folium
import os

app = Flask(__name__)

# --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
DATA_PATH = 'data/è¸åˆ‡_ç·¯åº¦çµŒåº¦è¿½åŠ _v5.csv'
df = pd.read_csv(DATA_PATH)

# --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®é¸æŠè‚¢ã‚’äº‹å‰ã«ä½œæˆ ---
FILTER_COLS = {
    'ç·šå': 'ç·šå',
    'æ”¯ç¤¾å': 'æ”¯ç¤¾å',
    'ç®‡æ‰€åï¼ˆç³»çµ±åãªã—ï¼‰': 'ç®‡æ‰€åï¼ˆç³»çµ±åãªã—ï¼‰',
    'è¸åˆ‡ç¨®åˆ¥': 'è¸åˆ‡ç¨®åˆ¥'
}
filters = {}
for key, col in FILTER_COLS.items():
    if col in df.columns:
        filters[key] = sorted(df[col].dropna().astype(str).unique().tolist())

def format_kilopost(value):
    if pd.isna(value): return ""
    try:
        value = float(value)
        kilo = int(value / 1000)
        meter = value % 1000
        return f"{kilo}k{meter:05.1f}m"
    except (ValueError, TypeError):
        return str(value)

@app.route('/', methods=['GET', 'POST'])
def index():
    filtered_df = df.copy()

    if request.method == 'POST':
        # ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸå€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        search_name = request.form.get('search_name', '')
        if search_name and 'è¸åˆ‡å' in filtered_df.columns:
            filtered_df = filtered_df[filtered_df['è¸åˆ‡å'].notna() & filtered_df['è¸åˆ‡å'].str.contains(search_name, na=False)]

        for key, col in FILTER_COLS.items():
            selected_value = request.form.get(key, 'ã™ã¹ã¦')
            if selected_value != 'ã™ã¹ã¦' and col in filtered_df.columns:
                filtered_df = filtered_df[filtered_df[col] == selected_value]

    map_html = None
    if not filtered_df.empty:
        center_lat = filtered_df['Lat'].mean()
        center_lon = filtered_df['Lon'].mean()
        m = folium.Map(location=[center_lat, center_lon], zoom_start=12)

        for _, row in filtered_df.iterrows():
            if pd.notna(row['Lat']) and pd.notna(row['Lon']):
                gmap_link = f"https://www.google.com/maps?q={row['Lat']},{row['Lon']}"
                formatted_kilopost = format_kilopost(row.get('ä¸­å¿ƒä½ç½®ã‚­ãƒ­ç¨‹'))
                popup_html = f"""
                    <b>è¸åˆ‡å:</b> {row.get('è¸åˆ‡å', 'åç§°ä¸æ˜')}<br>
                    <b>ç·šå:</b> {row.get('ç·šå', '')}<br>
                    <b>ã‚­ãƒ­ç¨‹:</b> {formatted_kilopost}<br>
                    <a href="{gmap_link}" target="_blank" rel="noopener noreferrer">Google Mapã§é–‹ã</a>
                """
                popup = folium.Popup(popup_html, max_width=300)
                folium.Marker(
                    location=[row['Lat'], row['Lon']],
                    popup=popup,
                    tooltip=row.get('è¸åˆ‡å', '')
                ).add_to(m)
        
        # åœ°å›³ã‚’HTMLã¨ã—ã¦å–å¾—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼ã¯ä¸è¦ï¼‰
        map_html = m._repr_html_()

    return render_template('index.html', map_html=map_html, filters=filters, count=len(filtered_df), request=request)

if __name__ == '__main__':
    app.run(debug=True)
```

---

### ## ã‚¹ãƒ†ãƒƒãƒ—3ï¼šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

1.  ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼ˆã¾ãŸã¯ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã€‚
2.  å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
    ```bash
    pip install -r requirements.txt
    ```
3.  Flaskã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™ã€‚
    ```bash
    flask run
    ```
4.  ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«è¡¨ç¤ºã•ã‚ŒãŸURLï¼ˆé€šå¸¸ã¯ `http://127.0.0.1:5000`ï¼‰ã‚’Webãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã¾ã™ã€‚

ã“ã‚Œã§Flaskç‰ˆã®è¸åˆ‡æ¤œç´¢ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚Streamlitç‰ˆã¨æ¯”ã¹ã¦ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ“ä½œã—ãŸéš›ã®å†èª­ã¿è¾¼ã¿ãŒã€Œæ¤œç´¢ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã ã‘ã«ãªã‚Šã€å‹•ä½œãŒã‚ˆã‚Šè»½å¿«ã«æ„Ÿã˜ã‚‰ã‚Œã‚‹ã¯ãš
